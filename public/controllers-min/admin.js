app.filter("flow1024",function(){return function(e){return e<1e3?e+" B":e<1e6?(e/1e3).toFixed(1)+" KB":e<1e9?(e/1e6).toFixed(1)+" MB":e<1e12?(e/1e9).toFixed(2)+" GB":e}}),app.filter("relativeTime",function(){return function(e){var t="",n="",r=+new Date-new Date(e);r<0?r=-r:n="前";var o=Math.trunc(r/864e5),a=Math.trunc(r%864e5/36e5),i=Math.trunc(r%864e5%36e5/6e4);return o&&(t+=o+"天"),(o||a)&&(t+=a+"小时"),o||!a&&!i||(t+=i+"分钟"),r<6e4&&(t="几秒"),t+n}}),app.filter("renewTime",function(){return function(e){var t=e,n="",r=Math.trunc(t/864e5),o=Math.trunc(t%864e5/36e5),a=Math.trunc(t%864e5%36e5/6e4),i=Math.trunc(t%864e5%36e5%6e4/1e3);return r&&(n+=r+"天"),(r||o)&&(n+=o+"小时"),r||!o&&!a||(n+=a+"分钟"),t<6e4&&(n+=i+"秒"),n}}),app.directive("focusMe",function(e,t){return{link:function(n,r,o){var a=t(o.focusMe);n.$watch(a,function(t){t===!0&&e(function(){r[0].focus()})}),r.bind("blur",function(){n.$apply(a.assign(n,!1))})}}}),app.controller("AdminIndexController",function(e,t,n){e.setTitle("首页"),e.setMenuButton("default"),e.init=function(){e.publicInfo.servers&&(e.users=angular.copy(e.publicInfo.users),e.users&&(e.userLastSign=e.users.sort(function(e,t){return e.createTime>t.createTime?-1:e.createTime<=t.createTime?1:0})[0],e.userLastLogin=e.users.filter(function(e){return e.lastLogin}).sort(function(e,t){return e.lastLogin>t.lastLogin?-1:e.lastLogin<=t.lastLogin?1:0})[0],e.serverSum=0,e.publicInfo.servers.forEach(function(t){t.account.forEach(function(t){t.month&&(e.serverSum+=t.month)})})))},e.init(),e.$on("initPublicInfo",function(t,n){"flow"===n&&e.init()}),e.toUser=function(e){n.go("admin.userPage",{userName:e})}}).controller("AdminEditAccountController",function(e,t,n,r,o,a,i,c,u,s){e.setTitle("编辑帐号"),e.serverName=r.serverName,e.setMenuButton("admin.serverPage",{serverName:r.serverName}),e.qrCode="";var l=function(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))};e.init=function(){e.publicInfo.servers&&(e.server=e.publicInfo.servers.filter(function(e){return e.name===r.serverName})[0],e.server||n.go("admin.serverPage",{serverName:r.serverName}),e.account=e.server.account.filter(function(e){return e.port===+r.accountPort})[0],e.account||n.go("admin.serverPage",{serverName:r.serverName}),e.qrCode="ss://"+l(e.server.method+":"+e.account.password+"@"+e.server.ip+":"+e.account.port))},e.toUserPage=function(t){e.setMenuButtonHistoryBack(),n.go("admin.userPage",{userName:t})},e.init(),e.$on("initPublicInfo",function(t,n){"server"===n&&e.init()}),e.setFlow=function(n,o){e.loading(!0),t.put("/api/admin/account",{type:n,name:r.serverName,port:r.accountPort,flow:o}).then(function(t){e.loading(!1),e.account.flow=+t.data.flow},function(t){e.loadingMessage({message:"设置流量出错",right:function(){e.loading(!1)}})})},e.setTime=function(n,o){e.loading(!0),t.put("/api/admin/account",{type:n,name:r.serverName,port:r.accountPort,time:o}).then(function(t){e.loading(!1),e.account.expireTime=t.data.expireTime},function(t){e.loadingMessage({message:"设置有效期出错",right:function(){e.loading(!1)}})})},e.setColor=function(n){e.loading(!0),t.post("/api/admin/accountColor",{name:r.serverName,port:r.accountPort,color:n}).then(function(t){e.account.color=t.data,e.loading(!1),o.cancel()},function(t){e.loadingMessage({message:"设置颜色出错",right:function(){e.loading(!1)}})})},e.flowBottomSheet=function(){o.show({templateUrl:"/public/views/admin/editAccountFlow.html",preserveScope:!0,scope:e,controller:function(e){}})},e.timeBottomSheet=function(){o.show({templateUrl:"/public/views/admin/editAccountTime.html",preserveScope:!0,scope:e,controller:function(e){}})},e.colorBottomSheet=function(){o.show({templateUrl:"/public/views/admin/editAccountColor.html",preserveScope:!0,scope:e,controller:function(e){}})};var f=function(e){var t=e.value;return t<1e3?t+" B":t<1e6?(t/1e3).toFixed(0)+" KB":t<1e9?(t/1e6).toFixed(0)+" MB":t<1e12?(t/1e9).toFixed(1)+" GB":t};e.chartType="",e.chartChange=function(t){"hour"===t?e.getChart(e.flowChart[r.serverName].hour,"hour"):"day"===t?e.getChart(e.flowChart[r.serverName].day,"day"):"week"===t?e.getChart(e.flowChart[r.serverName].week,"week"):e.chartType="day"},e.getChart=function(n,o){t.post("/api/admin/flowChart",{server:r.serverName,port:r.accountPort,type:o,page:e.flowChart[r.serverName][o].page}).then(function(t){n.sum=0,n.startTime=t.data[0].time,n.endTime=t.data[t.data.length-1].time,n.labels=[],n.series=[],n.data=[[]],t.data.forEach(function(e,t){"week"===o?n.labels[t]=i("date")(e.time,"EEE"):n.labels[t]=t%4===0?i("date")(e.time,"HH:mm"):"",n.data[0][t]=e.flow,n.sum+=e.flow}),n.options={pointHitDetectionRadius:1,scaleLabel:f,tooltipTemplate:f},e.chartType||(e.chartType="day")})},e.flowChart[r.serverName]||(e.flowChart[r.serverName]={hour:{page:0},day:{page:0},week:{page:0}}),e.prev=function(){e.flowChart[r.serverName][e.chartType].page+=1,e.getChart(e.flowChart[r.serverName][e.chartType],e.chartType)},e.reset=function(){e.flowChart[r.serverName].hour.page=0,e.flowChart[r.serverName].day.page=0,e.flowChart[r.serverName].week.page=0,e.getChart(e.flowChart[r.serverName].hour,"hour"),e.getChart(e.flowChart[r.serverName].day,"day"),e.getChart(e.flowChart[r.serverName].week,"week")},e.next=function(){0!==e.flowChart[r.serverName][e.chartType].page&&(e.flowChart[r.serverName][e.chartType].page-=1,e.getChart(e.flowChart[r.serverName][e.chartType],e.chartType))},e.getChart(e.flowChart[r.serverName].hour,"hour"),e.getChart(e.flowChart[r.serverName].day,"day"),e.getChart(e.flowChart[r.serverName].week,"week"),e.changeAutoRemove=function(){e.loading(!0),t.post("/api/admin/accountAutoRemove",{name:r.serverName,port:r.accountPort,value:e.account.autoRemove}).then(function(t){e.loading(!1)},function(t){e.loading(!1),e.account.autoRemove=!e.account.autoRemove})},e.deleteAccount=function(o){var a=u.confirm().title("").textContent("真的要删除帐号["+o+"]吗？").ariaLabel("delete").ok("确定").cancel("取消");u.show(a).then(function(){u.cancel(a),e.loading(!0),t["delete"]("/api/admin/account",{params:{name:r.serverName,port:o}}).then(function(t){n.go("admin.serverPage",{serverName:r.serverName}),e.server.account=e.server.account.filter(function(e){return e.port!==o})},function(t){e.loadingMessage({message:"删除账号失败",right:function(){e.loading(!1)}})})},function(){u.cancel(a)})}}).controller("AdminFlowController",function(e,t,n,r,o){e.setTitle("流量统计"),e.flowType=0,e.deselectTab=!1,e.tabs=[],e.tabIndex={value:0},e.init=function(){e.publicInfo.servers&&(e.tabs=e.publicInfo.servers)},e.init(),e.$on("initPublicInfo",function(t,n){"flow"===n&&e.init()}),e.select=function(e,t){},e.tabClick=function(t,n){e.deselectTab?(e.deselectTab=!1,r.go("admin.flow.server",{serverName:t})):e.flowType=1-e.flowType},e.deselect=function(t){e.deselectTab=!0}}).controller("AdminFlowServerController",function(e,t,n,r,o,a){e.setTitle("流量统计"),e.serverName=o.serverName,e.init=function(){if(e.publicInfo.servers){if(e.servers=e.publicInfo.servers,e.servers&&0===e.servers.length)return r.go("admin.index");if(o.serverName||"admin.flow.server"!==r.current.name||r.go("admin.flow.server",{serverName:e.tabs[0].name}),o.serverName||(o.serverName=e.tabs[0].name),e.server=e.publicInfo.servers.filter(function(t,n){if(t.name===o.serverName)return e.tabIndex.value=n,!0})[0],!e.server)return r.go("admin.index");e.server.sum={},e.server.sum.today=e.server.account.reduce(function(e,t){return t.today?e+t.today:e},0),e.server.sum.week=e.server.account.reduce(function(e,t){return t.week?e+t.week:e},0),e.server.sum.month=e.server.account.reduce(function(e,t){return t.month?e+t.month:e},0)}},e.init(),e.$on("initPublicInfo",function(t,n){"flow"===n&&e.init()}),e.accountPage=function(t,n){e.setMenuButtonHistoryBack(),r.go("admin.editAccount",{serverName:t,accountPort:n})};var i=function(e){var t=e.value;return t<1e3?t+" B":t<1e6?(t/1e3).toFixed(0)+" KB":t<1e9?(t/1e6).toFixed(0)+" MB":t<1e12?(t/1e9).toFixed(1)+" GB":t};e.chartType="hour",e.chartChange=function(t){"hour"===t&&e.getChart(e.flowChart[o.serverName].hour,"hour"),"day"===t&&e.getChart(e.flowChart[o.serverName].day,"day"),"week"===t&&e.getChart(e.flowChart[o.serverName].week,"week")},e.getChart=function(t,r){n.post("/api/admin/flowChart",{server:o.serverName,port:0,type:r,page:e.flowChart[o.serverName][r].page}).then(function(e){t.sum=0,t.startTime=e.data[0].time,t.endTime=e.data[e.data.length-1].time,t.labels=[],t.series=[],t.data=[[]],e.data.forEach(function(e,n){"week"===r?t.labels[n]=a("date")(e.time,"EEE"):t.labels[n]=n%4===0?a("date")(e.time,"HH:mm"):"",t.data[0][n]=e.flow,t.sum+=e.flow}),t.options={pointHitDetectionRadius:1,scaleLabel:i,tooltipTemplate:i}})},e.flowChart[o.serverName]||(e.flowChart[o.serverName]={hour:{page:0},day:{page:0},week:{page:0}}),e.prev=function(){e.flowChart[o.serverName][e.chartType].page+=1,e.getChart(e.flowChart[o.serverName][e.chartType],e.chartType)},e.reset=function(){e.flowChart[o.serverName].hour.page=0,e.flowChart[o.serverName].day.page=0,e.flowChart[o.serverName].week.page=0,e.getChart(e.flowChart[o.serverName].hour,"hour"),e.getChart(e.flowChart[o.serverName].day,"day"),e.getChart(e.flowChart[o.serverName].week,"week")},e.next=function(){0!==e.flowChart[o.serverName][e.chartType].page&&(e.flowChart[o.serverName][e.chartType].page-=1,e.getChart(e.flowChart[o.serverName][e.chartType],e.chartType))},e.getChart(e.flowChart[o.serverName].hour,"hour"),e.getChart(e.flowChart[o.serverName].day,"day"),e.getChart(e.flowChart[o.serverName].week,"week")}).controller("AdminUserController",function(e,t,n,r){e.setTitle("用户管理"),e.usersF=[],e.init=function(){e.publicInfo.users&&(e.users=e.publicInfo.users,e.usersF.length||(e.usersF=e.users))},e.init(),e.$on("initPublicInfo",function(t,n){"user"===n&&e.init()}),e.userPage=function(e){t.go("admin.userPage",{userName:e})},e.publicInfo.search=!0,e.$watch("publicInfo.searchText",function(){if(e.users){""===e.publicInfo.searchText&&(e.usersF=e.users);var t=new RegExp(e.publicInfo.searchText);e.usersF=e.users.filter(function(e){return e.email.match(t)}),e.page>Math.ceil(e.usersF.length/e.pageSize)&&(e.page=1)}}),e.$watch("usersF.length",function(){e.pages=Math.ceil(e.usersF.length/e.pageSize)}),e.pageSize=Math.floor((r.innerHeight-165)/49),e.pageSize<6&&(e.pageSize=6),e.page=1,e.prev=function(){1!==e.page&&(e.page-=1)},e.next=function(){e.page!==Math.ceil(e.usersF.length/e.pageSize)&&(e.page+=1)}}).controller("AdminUserPageController",function(e,t,n,r,o){e.setTitle("用户管理"),e.setMenuButton("admin.user"),e.setFabButtonClick(function(){n.go("admin.userAddAccount",{userName:r.userName})}),e.init=function(){if(e.publicInfo.users)return e.user=e.publicInfo.users.filter(function(e){return e.email===r.userName})[0],e.user?void 0:n.go("admin.user")},e.init(),e.$watch("publicInfo.users",function(){e.init()},!1),e["delete"]=function(n){var a=o.confirm().title("").textContent("真的要删除帐号["+n.port+"]吗？").ariaLabel("delete").ok("确定").cancel("取消");o.show(a).then(function(){t["delete"]("/api/admin/userAccount",{params:{name:r.userName,server:n.server,port:n.port}}).success(function(t){e.initPublicInfo()})},function(){o.cancel(a)})},e.edit=function(t){e.setMenuButtonHistoryBack(),n.go("admin.editAccount",{serverName:t.server,accountPort:t.port})}}).controller("AdminUserAddAccountController",function(e,t,n,r){e.setTitle("添加帐号"),e.setMenuButton("admin.userPage",{userName:r.userName}),e.init=function(){e.publicInfo.servers&&(e.servers=e.publicInfo.servers)},e.init(),e.$on("initPublicInfo",function(t,n){"server"===n&&e.init()}),e.$watch("server",function(){e.server&&(e.serverObj=JSON.parse(e.server),e.accounts=e.serverObj.account)}),e.addAccount=function(){e.account&&(e.accountObj=JSON.parse(e.account),t.post("/api/admin/userAccount",{name:r.userName,serverName:e.serverObj.name,port:e.accountObj.port}).success(function(t){e.initPublicInfo(),n.go("admin.userPage",{userName:r.userName})}))},e.cancel=function(){n.go("admin.userPage",{userName:r.userName})}}).controller("AdminRenewController",function(e,t,n,r){e.setTitle("续费码"),e.setFabButtonClick(function(){e.addCode()}),e.type={unuse:!0,use:!1},e.codeFilter=function(){e.codeF=e.codes.filter(function(t){return!(!t.isUsed||!e.type.use)||!(t.isUsed||!e.type.unuse)})},e.$watch("type",function(){e.codes&&e.codeFilter()},!0),e.init=function(){e.publicInfo.codes&&(e.codes=e.publicInfo.codes,e.codeFilter())},e.init(),e.$watch("publicInfo.codes",function(){e.init()},!1),e.newDate=function(){return new Date},e.newCode={flow:0,time:0,add:function(t,n){"flow"===t&&(e.newCode.flow+=n,e.newCode.flow<0&&(e.newCode.flow=0)),"time"===t&&(e.newCode.time+=n,e.newCode.time<0&&(e.newCode.time=0))},post:function(){e.loading(!0),t.post("/api/admin/code",{flow:e.newCode.flow,time:e.newCode.time}).then(function(t){n.cancel(),e.newCode.flow=0,e.newCode.time=0,e.loading(!1),e.publicInfo.codes.push(t.data)},function(t){n.cancel(),e.loadingMessage({message:"添加续费码失败",right:function(){e.loading(!1)}})})}},e.addCode=function(){n.show({templateUrl:"/public/views/admin/addCode.html",preserveScope:!0,scope:e,controller:function(e){}})},e.detail=function(e){var t=r.prompt({templateUrl:"/public/views/admin/renewCode.html",escapeToClose:!0,clickOutsideToClose:!0,locals:{code:e},controller:function(e,t){e.code=t}});r.show(t)}}).controller("AdminUnfinishController",function(e){e.setTitle("404 Not Found")}).controller("AdminOptionsController",function(e,t){e.setTitle("系统设置"),e.flow=[{number:5e7,name:"50 MB"},{number:8e7,name:"80 MB"},{number:1e8,name:"100 MB"},{number:2e8,name:"200 MB"},{number:3e8,name:"300 MB"}],e.time=[{number:7200,name:"2小时"},{number:14400,name:"4小时"},{number:28800,name:"8小时"},{number:43200,name:"12小时"},{number:64800,name:"18小时"}],e.osFlow=[{name:"10 MB",value:1e7},{name:"20 MB",value:2e7},{name:"40 MB",value:4e7},{name:"80 MB",value:8e7},{name:"160 MB",value:16e7}],e.osTime=[{name:"1小时",value:3600},{name:"2小时",value:7200},{name:"4小时",value:14400},{name:"8小时",value:28800},{name:"16小时",value:57600}],t.get("/api/admin/option").then(function(t){e.options=t.data}),e.setOptions=function(){e.loading(!0),t.post("/api/admin/option",{name:"freeServer",value:e.options.freeServer}).then(function(n){t.post("/api/admin/option",{name:"signInEnable",value:e.options.signInEnable})}).then(function(n){t.post("/api/admin/option",{name:"oneSecond",value:e.options.oneSecond})}).then(function(t){e.loadingMessage({message:"设置成功",right:function(){e.loading(!1)}})},function(t){e.loadingMessage({message:"设置失败",right:function(){e.loading(!1)}})})}});