app.controller("UserIndexController",function(t,e,n){t.setTitle("首页"),t.setMenuButton("default"),t.oneSecond=function(){t.loading(!0),e.post("/api/user/oneSecond").then(function(e){t.loadingMessage({message:"您已经成功续了1秒",right:function(){t.loading(!1),t.publicInfo.messageData="",t.initPublicInfo({loading:!0})}})},function(e){t.loadingMessage({message:e.data||"发生未知错误",right:function(){t.loading(!1)}})})}}).controller("UserAccountController",function(t,e,n){t.setTitle("我的帐户"),t.setMenuButton("default"),t.accountPage=function(t){n.go("user.accountPage",{serverName:t.server,accountPort:t.port})}}).controller("UserAccountPageController",function(t,e,n,o,r){t.setTitle("帐户详情"),t.setMenuButton("user.account"),t.qrCode="";var a=function(t){return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode("0x"+e)}))};t.$watch("publicInfo.user",function(){t.init()},!0),t.init=function(){if(t.publicInfo.user)return t.account=t.publicInfo.user.account.filter(function(t){return t.server===o.serverName&&+t.port===+o.accountPort})[0],t.account?void(t.qrCode="ss://"+a(t.account.method+":"+t.account.password+"@"+t.account.address+":"+t.account.port)):n.go("user.index")},t.init(),t.chart={};var c=function(t){var e=t.value;return e<1e3?e+" B":e<1e6?(e/1e3).toFixed(0)+" KB":e<1e9?(e/1e6).toFixed(0)+" MB":e<1e12?(e/1e9).toFixed(1)+" GB":e};t.getChart=function(){t.chart.sum=0,e.post("/api/user/flowChart",{server:o.serverName,port:o.accountPort}).then(function(e){t.chart.labels=[],t.chart.series=[],t.chart.data=[[]],e.data.forEach(function(e,n){t.chart.labels[n]=n%4===0?r("date")(e.time,"HH:mm"):"",t.chart.data[0][n]=e.flow,t.chart.sum+=e.flow}),t.chart.options={pointHitDetectionRadius:1,scaleLabel:c,tooltipTemplate:c}})},t.getChart()}).controller("UserChangePasswordController",function(t,e,n,o){t.setTitle("修改密码"),t.password={},t.changePassword=function(){t.loading(!0),e.put("/api/user/password",t.password).then(function(e){t.loadingMessage({message:"修改密码成功，点确定重新登陆",right:function(){o.location.reload()}})},function(e){t.loadingMessage({message:"修改密码失败("+e.status+")",right:function(){t.loading(!1)}})})}}).controller("UserRenewController",function(t,e,n){t.setTitle("续费"),t.setMenuButton("default"),t.renew={renewCode:""},t.renewIt=function(){t.loading(!0),e.post("/api/user/code",{code:t.renew.renewCode}).then(function(e){t.loadingMessage({message:"续费码使用成功",right:function(){t.loading(!1),t.publicInfo.messageData="",t.initPublicInfo({loading:!0})}})},function(e){t.loadingMessage({message:"续费码使用失败",right:function(){t.loading(!1)}})})}}).controller("UserFlowController",function(t,e,n){t.setTitle("流量统计"),t.$watch("publicInfo.user",function(){t.init()},!0),t.init=function(){if(t.publicInfo.user&&t.publicInfo.user.account[0]){var e=t.publicInfo.user.account[0].server,n=t.publicInfo.user.account[0].port;t.account[e+":"+n]=!0}},t.chartType="hour",t.page=0,t.account={},t.accountSum={},t.refresh=function(){var e=[],o=function(){t.chart.labels=[],t.chart.series=[],t.chart.data=[],Object.keys(t.account).filter(function(e){return t.account[e]}).forEach(function(e,o){var r=e.split(":")[0],a=+e.split(":")[1];t.chart.series[o]=e,t.chart.data[o]=[];var c=t.publicInfo.user.account.filter(function(t){return t.server===r&&t.port===a})[0];c&&(t.accountSum[e]=0,c.chart[t.chartType].forEach(function(r,a){0===o&&(0===a&&(t.startTime=r.time),a===c.chart[t.chartType].length-1&&(t.endTime=r.time),"week"===t.chartType?t.chart.labels[a]=n("date")(r.time,"EEE"):t.chart.labels[a]=a%4===0?n("date")(r.time,"HH:mm"):""),t.chart.data[o][a]=r.flow,t.accountSum[e]+=r.flow}))})};Object.keys(t.account).filter(function(e){return t.account[e]}).forEach(function(n,o){var r=n.split(":")[0],a=+n.split(":")[1];e.push(t.getChart(r,a,t.chartType))}),Promise.all(e).then(function(e){t.$apply(function(){o()})})},t.$watch("account",t.refresh,!0),t.reset=function(){t.page=0,t.refresh()},t.prev=function(){t.page+=1,t.refresh()},t.next=function(){0!==t.page&&(t.page-=1,t.refresh())},t.chart={};var o=function(t){var e=t.value;return e<1e3?e+" B":e<1e6?(e/1e3).toFixed(0)+" KB":e<1e9?(e/1e6).toFixed(0)+" MB":e<1e12?(e/1e9).toFixed(1)+" GB":e};t.chart.options={pointHitDetectionRadius:1,scaleLabel:o,tooltipTemplate:o},t.getChart=function(n,o,r){return new Promise(function(a,c){var i=t.publicInfo.user.account.filter(function(t){return t.server===n&&t.port===o})[0];return i?(i.chart||(i.chart={hour:[],day:[],week:[]}),void e.post("/api/user/flowChart",{server:n,port:o,type:r,page:t.page}).then(function(t){i.chart[r]=t.data,a()},function(t){c()})):Promise.reject()})}}).controller("UserUnfinishController",function(t){t.setTitle("404 Not Found")});