var fingerprint="";(new Fingerprint2).get(function(n,o){fingerprint=n}),app.controller("MainController",function(n,o,i,e,s,t){n.publicInfo={customButton:"",customButtonFn:function(){}},n.isLoading=!1,n.loadingText="正在加载",n.loadingError="",n.loadingErrorFn=function(){};var r=e.prompt({templateUrl:"/public/views/home/loading.html",escapeToClose:!1,scope:n,preserveScope:!0,controller:function(n){n.isLoading=!0}});n.loading=function(o,i,s){if(o)i?(n.loadingError=i,n.loadingErrorFn=s||function(){}):e.show(r);else var t=n.$watch("isLoading",function(){n.isLoading&&(e.cancel(),t(),n.isLoading=!1,n.loadingText="正在加载",n.loadingError="",n.loadingErrorFn=function(){})})}}).controller("LoginController",function(n,o,i,e,s,t){n.user={username:"",password:""},n.signup=function(){return n.user.username&&n.user.password?(n.loading(!0),void o.post("/api/home/signup",{username:n.user.username,password:n.user.password,fingerprint:fingerprint}).then(function(o){n.loading(!1),n.publicInfo.message="注册成功，请前往邮箱激活此帐户",i.go("home.signupSuccess")},function(o){n.loading(!0,o.data||"发生未知错误",function(){n.loading(!1)})})):(n.loading(!0),void n.loading(!0,"请填写完整的邮箱和密码，并点击“注册”按钮",function(){n.loading(!1)}))},n.login=function(){return n.user.username&&n.user.password?(n.loading(!0),void o.post("/api/home/login",n.user).then(function(n){t.location.reload()},function(i){"该用户的邮箱未验证"===i.data?(n.publicInfo.customButton="重发邮件",n.publicInfo.customButtonFn=function(){n.publicInfo.customButton="",o.post("/api/home/email",{username:n.user.username}),n.loading(!1),n.publicInfo.customButtonFn=function(){}},n.loading(!0,"该用户的邮箱未验证，如未收到激活邮件，请点击“重发邮件”按钮",function(){n.loading(!1)})):n.loading(!0,i.data||"发生未知错误",function(){n.loading(!1)})})):(n.loading(!0),void n.loading(!0,"请填写完整的邮箱和密码，并点击“登录”按钮",function(){n.loading(!1)}))},n.findPassword=function(){return n.user.username?(n.loading(!0),void o.post("/api/home/findPassword",{username:n.user.username}).then(function(o){n.loading(!1),n.publicInfo.message="重置密码邮件已发送，请注意查收",i.go("home.signupSuccess")},function(o){n.loading(!0,o.data||"发生未知错误",function(){n.loading(!1)})})):(n.loading(!0),void n.loading(!0,"请填写完整的邮箱，并点击“找回密码”按钮",function(){n.loading(!1)}))},n.passwordKeypress=function(o){13===o.keyCode&&n.login()}}).controller("SignupSuccessController",function(n,o,i,e){n.time=10;var s=i(function(){n.time-=.1,n.timeStr=n.time.toString().split(".")[0],n.time<=0&&(n.timeStr="0",i.cancel(s),e.go("home.index"))},100)}).controller("LoginActiveController",function(n,o,i,e,s){o.post("/api/home/active",{activeKey:s.activeKey}).then(function(o){n.publicInfo.message="激活成功！",e.go("home.signupSuccess")},function(o){n.publicInfo.message="激活失败，请重发激活邮件",e.go("home.signupSuccess")})}).controller("ResetPasswordController",function(n,o,i,e,s){n.user={password:""},n.isLoading=!0,o.get("/api/home/findPassword",{params:{key:s.resetPasswordKey}}).then(function(o){n.isLoading=!1},function(o){n.publicInfo.message="无效的key",e.go("home.signupSuccess")}),n.resetPassword=function(){o.post("/api/home/resetPassword",{key:s.resetPasswordKey,password:n.user.password}).then(function(o){n.publicInfo.message="重置密码成功，请重新登录",e.go("home.signupSuccess")},function(o){n.publicInfo.message="重置密码失败",e.go("home.signupSuccess")})}});